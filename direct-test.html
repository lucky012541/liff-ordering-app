<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Test - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Test overlay styles */
        .test-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px;
            height: 100vh;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .test-header {
            background: #3498db;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            text-align: center;
            font-weight: bold;
        }
        
        .test-controls {
            margin-bottom: 20px;
        }
        
        .test-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
            font-size: 11px;
        }
        
        .test-btn:hover {
            background: #229954;
        }
        
        .test-btn.danger {
            background: #e74c3c;
        }
        
        .test-stats {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .test-log {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-size: 11px;
        }
        
        .log-entry {
            margin-bottom: 3px;
            padding: 2px 5px;
            border-radius: 2px;
        }
        
        .log-success {
            background: rgba(39, 174, 96, 0.3);
        }
        
        .log-error {
            background: rgba(231, 76, 60, 0.3);
        }
        
        .log-warning {
            background: rgba(243, 156, 18, 0.3);
        }
        
        .log-info {
            background: rgba(52, 152, 219, 0.3);
        }
        
        /* Highlight tested elements */
        .test-highlight {
            outline: 3px solid #f39c12 !important;
            background: rgba(243, 156, 18, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Test Overlay -->
    <div class="test-overlay">
        <div class="test-header">
            ü§ñ DIRECT TEST BOT
        </div>
        
        <div class="test-controls">
            <button class="test-btn" onclick="runFullTest()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            <button class="test-btn" onclick="testProducts()">üõçÔ∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button class="test-btn" onclick="testCompleteCheckout()">üí≥ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</button>
            <button class="test-btn" onclick="debugCheckoutState()">üîç Debug</button>
            <button class="test-btn danger" onclick="clearLog()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
        
        <div class="test-stats">
            <div>üìä ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalTests">0</span></div>
            <div>‚úÖ ‡∏ú‡πà‡∏≤‡∏ô: <span id="passedTests">0</span></div>
            <div>‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: <span id="failedTests">0</span></div>
        </div>
        
        <div class="test-log" id="testLog">
            <div class="log-entry log-info">ü§ñ Test Bot ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
        </div>
    </div>

    <!-- Original App Content -->
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-shopping-cart"></i> ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            <div class="user-info" id="userInfo">
                <span id="userName">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="menu">
                    <i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
            </div>
        </div>
    </nav>

    <main class="main">
        <div class="container">
            <div class="tab-content active" id="products">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="category-filter">
                    <button class="category-btn active" data-category="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="category-btn" data-category="ice">‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á</button>
                    <button class="category-btn" data-category="water">‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</button>
                    <button class="category-btn" data-category="gas">‡πÅ‡∏Å‡πä‡∏™‡∏´‡∏∏‡∏á‡∏ï‡πâ‡∏°</button>
                </div>

                <div class="products-grid" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom App Bar -->
    <div class="bottom-app-bar" id="bottomAppBar">
        <div class="cart-info-mini" id="cartInfoMini">
            <div class="cart-icon">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cartCountMini">0</span>
            </div>
            <div class="cart-details">
                <span id="cartItemsText">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <span id="cartTotalText">‡∏ø0</span>
            </div>
        </div>
        <button class="checkout-btn-mini" id="checkoutBtnMini">
            <span>‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <!-- Include all modals and other elements from original app -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <div class="modal-body">
                <div id="modalProductImage" class="product-icon"></div>
                <div class="modal-info">
                    <h3 id="modalProductName"></h3>
                    <p id="modalProductDescription"></p>
                    <div class="price-quantity">
                        <span class="price" id="modalProductPrice"></span>
                        <div class="quantity-controls">
                            <button class="qty-btn" id="decreaseQty">-</button>
                            <span id="modalQuantity">1</span>
                            <button class="qty-btn" id="increaseQty">+</button>
                        </div>
                    </div>
                    <button class="add-to-cart-btn" id="addToCartBtn">
                        <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content checkout-modal">
            <span class="close" id="closeCheckoutModal">&times;</span>
            <div class="checkout-header">
                <h2>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                <div class="checkout-stepper" id="checkoutStepper"></div>
            </div>
            <div class="checkout-body">
                <!-- Step 1: Cart Review -->
                <div class="checkout-step" id="cartReviewStep">
                    <h3>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div class="cart-review" id="cartReview"></div>
                </div>

                <!-- Step 2: Customer Info -->
                <div class="checkout-step" id="customerInfoStep">
                    <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3>
                    <div class="form-group">
                        <label for="customerName">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label>
                        <input type="tel" id="customerPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryAddress">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á *</label>
                        <textarea id="deliveryAddress" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="deliveryNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <textarea id="deliveryNote" rows="2"></textarea>
                    </div>
                </div>

                <!-- Step 3: Payment Method -->
                <div class="checkout-step" id="paymentStep">
                    <h3>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="cash" checked>
                            <div class="payment-info">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</span>
                            </div>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="transfer">
                            <div class="payment-info">
                                <i class="fas fa-university"></i>
                                <span>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                            </div>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="promptpay">
                            <div class="payment-info">
                                <i class="fas fa-qrcode"></i>
                                <span>PromptPay</span>
                            </div>
                        </label>
                    </div>
                    <div class="payment-details" id="paymentDetails"></div>
                </div>

                <!-- Step 4: Order Summary -->
                <div class="checkout-step" id="summaryStep">
                    <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                    <div class="order-summary" id="orderSummary"></div>
                </div>

                <!-- Step 5: Receipt -->
                <div class="checkout-step" id="receiptStep">
                    <h3>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="receipt" id="receipt"></div>
                </div>
            </div>
            <div class="checkout-footer">
                <button class="checkout-btn secondary" id="prevStepBtn" style="display: none;">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="checkout-btn" id="nextStepBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Load original script -->
    <script src="script.js"></script>

    <!-- Test Bot Script -->
    <script>
        let testStats = { total: 0, passed: 0, failed: 0 };
        let isTestRunning = false;

        // Test logging
        function testLog(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        // Update test statistics
        function updateTestStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
        }

        // Highlight element being tested
        function highlightElement(element, duration = 1000) {
            if (element) {
                element.classList.add('test-highlight');
                setTimeout(() => {
                    element.classList.remove('test-highlight');
                }, duration);
            }
        }

        // Test step wrapper
        async function testStep(description, testFn) {
            testStats.total++;
            testLog(`üîç ${description}`, 'info');
            
            try {
                const result = await testFn();
                if (result !== false) {
                    testStats.passed++;
                    testLog(`‚úÖ ${description} - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
                    return true;
                } else {
                    testStats.failed++;
                    testLog(`‚ùå ${description} - ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`, 'error');
                    return false;
                }
            } catch (error) {
                testStats.failed++;
                testLog(`‚ùå ${description} - ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                return false;
            } finally {
                updateTestStats();
            }
        }

        // Delay function
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Test products
        async function testProducts() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            testLog('üõçÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...', 'info');

            // Test search
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', async () => {
                const searchInput = document.getElementById('searchInput');
                if (!searchInput) return false;
                
                highlightElement(searchInput);
                searchInput.value = '‡∏ô‡πâ‡∏≥';
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                await delay(500);
                
                // Clear search
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                return true;
            });

            // Test categories
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', async () => {
                const categoryBtns = document.querySelectorAll('.category-btn');
                if (categoryBtns.length < 2) return false;
                
                // Click different categories
                for (let i = 1; i < Math.min(3, categoryBtns.length); i++) {
                    highlightElement(categoryBtns[i]);
                    categoryBtns[i].click();
                    await delay(300);
                }
                
                // Back to all
                categoryBtns[0].click();
                return true;
            });

            // Test product selection
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', async () => {
                // Wait for products to load
                await delay(1000);
                
                const productCards = document.querySelectorAll('.product-card');
                if (productCards.length === 0) return false;
                
                highlightElement(productCards[0]);
                productCards[0].click();
                await delay(500);
                
                // Test modal
                const modal = document.getElementById('productModal');
                if (!modal || modal.style.display === 'none') return false;
                
                // Test quantity controls
                const increaseBtn = document.getElementById('increaseQty');
                const addBtn = document.getElementById('addToCartBtn');
                
                if (increaseBtn) {
                    highlightElement(increaseBtn);
                    increaseBtn.click();
                    await delay(200);
                }
                
                if (addBtn) {
                    highlightElement(addBtn);
                    addBtn.click();
                    await delay(500);
                }
                
                // Close modal
                const closeBtn = document.getElementById('closeModal');
                if (closeBtn) {
                    closeBtn.click();
                }
                
                return true;
            });

            testLog('‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
            isTestRunning = false;
        }

        // Test checkout
        async function testCheckout() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            testLog('üí≥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...', 'info');

            // Ensure we have items in cart first
            await testStep('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', async () => {
                const productCards = document.querySelectorAll('.product-card');
                if (productCards.length === 0) return false;
                
                // Add a product to cart
                productCards[0].click();
                await delay(500);
                
                const addBtn = document.getElementById('addToCartBtn');
                if (addBtn) {
                    addBtn.click();
                    await delay(300);
                }
                
                const closeBtn = document.getElementById('closeModal');
                if (closeBtn) {
                    closeBtn.click();
                    await delay(300);
                }
                
                return true;
            });

            // Test checkout button
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', async () => {
                const checkoutBtn = document.getElementById('checkoutBtnMini');
                if (!checkoutBtn) return false;
                
                highlightElement(checkoutBtn);
                checkoutBtn.click();
                await delay(1000);
                
                const modal = document.getElementById('checkoutModal');
                return modal && modal.style.display !== 'none';
            });

            // Test customer form
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', async () => {
                const nameInput = document.getElementById('customerName');
                const phoneInput = document.getElementById('customerPhone');
                const addressInput = document.getElementById('deliveryAddress');
                
                if (!nameInput || !phoneInput || !addressInput) return false;
                
                highlightElement(nameInput);
                nameInput.value = '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏≠‡∏ó';
                nameInput.dispatchEvent(new Event('input', { bubbles: true }));
                await delay(200);
                
                highlightElement(phoneInput);
                phoneInput.value = '0812345678';
                phoneInput.dispatchEvent(new Event('input', { bubbles: true }));
                await delay(200);
                
                highlightElement(addressInput);
                addressInput.value = '123 ‡∏ñ‡∏ô‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10100';
                addressInput.dispatchEvent(new Event('input', { bubbles: true }));
                
                return true;
            });

            // Test next button
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', async () => {
                const nextBtn = document.getElementById('nextStepBtn');
                if (!nextBtn) return false;
                
                highlightElement(nextBtn);
                nextBtn.click();
                await delay(1000);
                
                return true;
            });

            // Test payment method
            await testStep('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', async () => {
                const cashRadio = document.querySelector('input[name="paymentMethod"][value="cash"]');
                if (!cashRadio) return false;
                
                highlightElement(cashRadio.closest('.payment-option'));
                cashRadio.click();
                await delay(500);
                
                return true;
            });

            // Continue to next step (Summary)
            await testStep('‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡∏∏‡∏õ', async () => {
                const nextBtn = document.getElementById('nextStepBtn');
                if (!nextBtn) return false;
                
                highlightElement(nextBtn);
                nextBtn.click();
                await delay(1000);
                
                return true;
            });

            // Test order confirmation
            await testStep('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', async () => {
                const nextBtn = document.getElementById('nextStepBtn');
                if (!nextBtn) return false;
                
                // Check if button text changed to confirm
                if (nextBtn.textContent.includes('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô') || nextBtn.textContent.includes('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠')) {
                    highlightElement(nextBtn);
                    nextBtn.click();
                    await delay(2000);
                    
                    // Check if receipt step is shown
                    const receiptStep = document.getElementById('receiptStep');
                    return receiptStep && receiptStep.style.display !== 'none';
                }
                
                return false;
            });

            // Test receipt display
            await testStep('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', async () => {
                const receipt = document.getElementById('receipt');
                if (!receipt) return false;
                
                highlightElement(receipt);
                
                // Check if receipt has content
                const hasContent = receipt.innerHTML.trim().length > 0;
                if (hasContent) {
                    testLog('üìÑ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
                
                return hasContent;
            });

            // Test close modal
            await testStep('‡∏õ‡∏¥‡∏î Modal', async () => {
                const closeBtn = document.getElementById('closeCheckoutModal');
                if (!closeBtn) return false;
                
                highlightElement(closeBtn);
                closeBtn.click();
                await delay(500);
                
                const modal = document.getElementById('checkoutModal');
                return modal && modal.style.display === 'none';
            });

            testLog('‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', 'success');
            isTestRunning = false;
        }

        // Complete checkout test with all steps
        async function testCompleteCheckout() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            testLog('üõí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£...', 'info');

            // Step 1: Add product to cart
            await testStep('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', async () => {
                const productCards = document.querySelectorAll('.product-card');
                if (productCards.length === 0) return false;
                
                highlightElement(productCards[0]);
                productCards[0].click();
                await delay(800);
                
                const addBtn = document.getElementById('addToCartBtn');
                if (addBtn) {
                    highlightElement(addBtn);
                    addBtn.click();
                    await delay(500);
                }
                
                const closeBtn = document.getElementById('closeModal');
                if (closeBtn) {
                    closeBtn.click();
                    await delay(300);
                }
                
                return true;
            });

            // Step 2: Open checkout
            await testStep('‡πÄ‡∏õ‡∏¥‡∏î Checkout Modal', async () => {
                const checkoutBtn = document.getElementById('checkoutBtnMini');
                if (!checkoutBtn) return false;
                
                highlightElement(checkoutBtn);
                checkoutBtn.click();
                await delay(1500);
                
                const modal = document.getElementById('checkoutModal');
                return modal && modal.style.display !== 'none';
            });

            // Step 3: Fill customer info
            await testStep('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', async () => {
                const fields = [
                    { id: 'customerName', value: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏ö‡∏≠‡∏ó' },
                    { id: 'customerPhone', value: '0812345678' },
                    { id: 'deliveryAddress', value: '123 ‡∏ñ‡∏ô‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÄ‡∏Ç‡∏ï‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10100' },
                    { id: 'deliveryNote', value: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏î‡∏™‡∏≠‡∏ö' }
                ];
                
                for (const field of fields) {
                    const input = document.getElementById(field.id);
                    if (input) {
                        highlightElement(input);
                        input.value = field.value;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                        await delay(200);
                    }
                }
                
                return true;
            });

            // Step 4: Go to payment step
            await testStep('‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', async () => {
                const nextBtn = document.getElementById('nextStepBtn');
                if (!nextBtn) return false;
                
                highlightElement(nextBtn);
                nextBtn.click();
                await delay(1500);
                
                // Check if we're on payment step
                const paymentStep = document.getElementById('paymentStep');
                return paymentStep && paymentStep.style.display !== 'none';
            });

            // Step 5: Select payment method
            await testStep('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', async () => {
                const cashRadio = document.querySelector('input[name="paymentMethod"][value="cash"]');
                if (!cashRadio) return false;
                
                highlightElement(cashRadio.closest('.payment-option'));
                cashRadio.checked = true;
                cashRadio.dispatchEvent(new Event('change', { bubbles: true }));
                await delay(800);
                
                return cashRadio.checked;
            });

            // Step 6: Go to summary
            await testStep('‡πÑ‡∏õ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡∏∏‡∏õ', async () => {
                const nextBtn = document.getElementById('nextStepBtn');
                if (!nextBtn) return false;
                
                highlightElement(nextBtn);
                nextBtn.click();
                await delay(1500);
                
                // Check if we're on summary step
                const summaryStep = document.getElementById('summaryStep');
                return summaryStep && summaryStep.style.display !== 'none';
            });

            // Step 7: Confirm order
            await testStep('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', async () => {
                const nextBtn = document.getElementById('nextStepBtn');
                if (!nextBtn) {
                    testLog('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', 'error');
                    return false;
                }
                
                testLog(`‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: "${nextBtn.textContent}"`, 'info');
                
                // Check if button text indicates confirmation step
                const isConfirmButton = nextBtn.textContent.includes('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô') || 
                                      nextBtn.textContent.includes('‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠') ||
                                      nextBtn.textContent.includes('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
                
                if (!isConfirmButton) {
                    testLog(`‚ö†Ô∏è ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô: "${nextBtn.textContent}"`, 'warning');
                    // Try clicking anyway
                }
                
                highlightElement(nextBtn);
                nextBtn.click();
                
                // Wait longer and check multiple times
                for (let i = 0; i < 10; i++) {
                    await delay(500);
                    
                    // Check if receipt step is visible
                    const receiptStep = document.getElementById('receiptStep');
                    if (receiptStep && receiptStep.style.display !== 'none') {
                        testLog('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        return true;
                    }
                    
                    // Check if receipt has content
                    const receipt = document.getElementById('receipt');
                    if (receipt && receipt.innerHTML.trim().length > 50) {
                        testLog('‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        return true;
                    }
                    
                    // Check if toast appears
                    const toast = document.getElementById('toast');
                    if (toast && toast.classList.contains('show')) {
                        testLog('üéâ Toast ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        // Continue checking for receipt
                    }
                    
                    // Check if modal closed (order completed)
                    const modal = document.getElementById('checkoutModal');
                    if (modal && modal.style.display === 'none') {
                        testLog('‚ÑπÔ∏è Modal ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'info');
                        return true;
                    }
                    
                    testLog(`‚è≥ ‡∏£‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à... (${i + 1}/10)`, 'warning');
                }
                
                testLog('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', 'error');
                return false;
            });

            // Step 8: Detailed final state check
            await testStep('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢', async () => {
                const modal = document.getElementById('checkoutModal');
                const receipt = document.getElementById('receipt');
                const receiptStep = document.getElementById('receiptStep');
                
                // Debug current state
                testLog('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:', 'info');
                testLog(`Modal display: ${modal ? modal.style.display : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, 'info');
                testLog(`Receipt step display: ${receiptStep ? receiptStep.style.display : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, 'info');
                testLog(`Receipt content length: ${receipt ? receipt.innerHTML.length : 0}`, 'info');
                
                // Check all checkout steps to see which one is active
                const steps = ['cartReviewStep', 'customerInfoStep', 'paymentStep', 'summaryStep', 'receiptStep'];
                for (const stepId of steps) {
                    const step = document.getElementById(stepId);
                    if (step && step.style.display !== 'none') {
                        testLog(`üìç ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${stepId}`, 'info');
                    }
                }
                
                // Check if we're actually on receipt step
                if (receiptStep && receiptStep.style.display !== 'none') {
                    testLog('‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', 'success');
                    highlightElement(receiptStep);
                    
                    // Force render receipt if empty
                    if (receipt && receipt.innerHTML.trim().length === 0) {
                        testLog('üîÑ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...', 'warning');
                        
                        // Try to call renderReceipt from the app
                        if (window.app && typeof window.app.renderReceipt === 'function') {
                            window.app.renderReceipt();
                            await delay(500);
                        }
                    }
                    
                    if (receipt && receipt.innerHTML.trim().length > 0) {
                        testLog('‚úÖ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', 'success');
                        highlightElement(receipt);
                        
                        // Show receipt content preview
                        const receiptPreview = receipt.textContent.substring(0, 100);
                        testLog(`üìÑ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${receiptPreview}...`, 'info');
                        
                        // Wait to let user see the receipt
                        await delay(3000);
                        
                        // Try to close modal
                        const closeBtn = document.getElementById('closeCheckoutModal');
                        if (closeBtn) {
                            testLog('üîÑ ‡∏õ‡∏¥‡∏î Modal', 'info');
                            highlightElement(closeBtn);
                            closeBtn.click();
                            await delay(500);
                        }
                        
                        return true;
                    } else {
                        testLog('‚ùå ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ - ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
                        
                        // Debug: check app state
                        if (window.app) {
                            testLog(`üõí Cart items: ${window.app.cart.length}`, 'info');
                            testLog(`üí≥ Payment method: ${window.app.paymentMethod}`, 'info');
                        }
                        
                        return false;
                    }
                } else {
                    testLog('‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', 'error');
                    
                    // Check if order was completed differently
                    if (modal && modal.style.display === 'none') {
                        testLog('‚ÑπÔ∏è Modal ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'info');
                        return true;
                    }
                    
                    return false;
                }
            });

            testLog('üéâ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
            isTestRunning = false;
        }

        // Run full test
        async function runFullTest() {
            if (isTestRunning) return;
            
            testLog('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'info');
            
            await testProducts();
            await delay(1000);
            await testCompleteCheckout();
            
            testLog('üéâ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'success');
            testLog(`üìä ‡∏™‡∏£‡∏∏‡∏õ: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${testStats.total} ‡∏ú‡πà‡∏≤‡∏ô ${testStats.passed} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${testStats.failed}`, 'info');
            
            // Show final summary
            const successRate = testStats.total > 0 ? ((testStats.passed / testStats.total) * 100).toFixed(1) : 0;
            testLog(`üìà ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successRate}%`, successRate >= 80 ? 'success' : 'warning');
        }

        // Debug checkout state
        function debugCheckoutState() {
            testLog('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏° Debug ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Checkout...', 'info');
            
            const modal = document.getElementById('checkoutModal');
            const receipt = document.getElementById('receipt');
            const receiptStep = document.getElementById('receiptStep');
            
            testLog(`Modal exists: ${!!modal}`, 'info');
            testLog(`Modal display: ${modal ? modal.style.display : 'N/A'}`, 'info');
            testLog(`Receipt exists: ${!!receipt}`, 'info');
            testLog(`Receipt step exists: ${!!receiptStep}`, 'info');
            testLog(`Receipt step display: ${receiptStep ? receiptStep.style.display : 'N/A'}`, 'info');
            
            // Check all steps
            const steps = ['cartReviewStep', 'customerInfoStep', 'paymentStep', 'summaryStep', 'receiptStep'];
            testLog('üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:', 'info');
            
            for (const stepId of steps) {
                const step = document.getElementById(stepId);
                if (step) {
                    const isVisible = step.style.display !== 'none';
                    testLog(`  ${stepId}: ${isVisible ? '‚úÖ ‡πÅ‡∏™‡∏î‡∏á' : '‚ùå ‡∏ã‡πà‡∏≠‡∏ô'}`, isVisible ? 'success' : 'warning');
                    if (isVisible) {
                        highlightElement(step, 2000);
                    }
                } else {
                    testLog(`  ${stepId}: ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö`, 'error');
                }
            }
            
            // Check buttons
            const nextBtn = document.getElementById('nextStepBtn');
            const prevBtn = document.getElementById('prevStepBtn');
            
            testLog('üéõÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°:', 'info');
            testLog(`  Next button: ${nextBtn ? `"${nextBtn.textContent}"` : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, nextBtn ? 'success' : 'error');
            testLog(`  Prev button: ${prevBtn ? `"${prevBtn.textContent}"` : '‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, prevBtn ? 'success' : 'error');
            
            if (nextBtn) {
                highlightElement(nextBtn, 2000);
            }
            
            // Check cart state
            const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
            testLog(`üõí ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤: ${cartItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, cartItems.length > 0 ? 'success' : 'warning');
            
            // Check orders
            const orders = JSON.parse(localStorage.getItem('liff_orders') || '[]');
            testLog(`üì¶ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${orders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'info');
            
            if (orders.length > 0) {
                const lastOrder = orders[orders.length - 1];
                testLog(`üìã ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: #${lastOrder.id} (${lastOrder.status})`, 'info');
            }
        }

        // Clear log
        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div class="log-entry log-info">ü§ñ Test Bot ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>';
            testStats = { total: 0, passed: 0, failed: 0 };
            updateTestStats();
        }

        // Auto-start test when page loads
        window.addEventListener('load', () => {
            testLog('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à', 'success');
            updateTestStats();
            
            // Auto-start test after 2 seconds
            setTimeout(() => {
                testLog('ü§ñ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...', 'info');
                runFullTest();
            }, 2000);
        });
    </script>
</body>
</html>
